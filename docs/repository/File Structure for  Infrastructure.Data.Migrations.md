# Specification

# 1. Files

- **Path:** src/Infrastructure/Data.Migrations/Opc.System.Infrastructure.Data.Migrations.csproj  
**Description:** The .NET 8 project file for the database migrations project. This file defines the project's target framework, dependencies on Entity Framework Core tools, the specific database provider (e.g., Npgsql.EntityFrameworkCore.PostgreSQL), and a project reference to the main data access project (Opc.System.Infrastructure.Data) where the DbContext and entity configurations are defined.  
**Template:** C# Class Library  
**Dependency Level:** 0  
**Name:** Opc.System.Infrastructure.Data.Migrations  
**Type:** Project  
**Relative Path:** .  
**Repository Id:** REPO-SAP-010  
**Pattern Ids:**
    
    
**Members:**
    
    
**Methods:**
    
    
**Implemented Features:**
    
    - Project Definition
    - Dependency Management
    
**Requirement Ids:**
    
    - REQ-DLP-004
    - REQ-DLP-007
    - REQ-CSVC-016
    - REQ-CSVC-022
    
**Purpose:** To configure the build properties and package dependencies necessary for creating and applying Entity Framework Core migrations.  
**Logic Description:** This XML file will contain ItemGroup sections to reference necessary NuGet packages like Microsoft.EntityFrameworkCore.Design, Microsoft.EntityFrameworkCore.Tools, and the database provider. A ProjectReference will point to the Opc.System.Infrastructure.Data project to access its DbContext and entity classes.  
**Documentation:**
    
    - **Summary:** Defines the structure and dependencies of the migrations project, enabling it to function correctly within the .NET ecosystem and interact with Entity Framework Core tools.
    
**Namespace:**   
**Metadata:**
    
    - **Category:** Configuration
    
- **Path:** src/Infrastructure/Data.Migrations/DbContextFactory.cs  
**Description:** An implementation of IDesignTimeDbContextFactory which is used by Entity Framework Core design-time tools (like `dotnet ef migrations add`) to create an instance of the ApplicationDbContext. This is crucial for a separate migrations project as it provides a hook to configure the DbContext correctly without needing to run the main application.  
**Template:** C# Class  
**Dependency Level:** 1  
**Name:** DbContextFactory  
**Type:** Factory  
**Relative Path:** DbContextFactory  
**Repository Id:** REPO-SAP-010  
**Pattern Ids:**
    
    - Factory
    
**Members:**
    
    
**Methods:**
    
    - **Name:** CreateDbContext  
**Parameters:**
    
    - string[] args
    
**Return Type:** ApplicationDbContext  
**Attributes:** public  
    
**Implemented Features:**
    
    - Design-Time DbContext Creation
    
**Requirement Ids:**
    
    - REQ-DLP-004
    - REQ-DLP-007
    - REQ-CSVC-016
    - REQ-CSVC-022
    
**Purpose:** To enable the `dotnet-ef` tools to create instances of the ApplicationDbContext for scaffolding migrations, independent of the main application's runtime configuration.  
**Logic Description:** This class implements the CreateDbContext method. Inside this method, it will set up a ConfigurationBuilder to read a connection string from a design-time configuration source (e.g., `appsettings.Development.json`). It will then create an instance of DbContextOptionsBuilder, configure the appropriate database provider (e.g., UseNpgsql or UseSqlServer), and pass the connection string and the configured migrations assembly. Finally, it will return a new instance of ApplicationDbContext with these options.  
**Documentation:**
    
    - **Summary:** Provides a design-time instantiation point for the ApplicationDbContext, allowing database migrations to be managed in a separate, dedicated project.
    
**Namespace:** Opc.System.Infrastructure.Data.Migrations  
**Metadata:**
    
    - **Category:** DataAccess
    
- **Path:** src/Infrastructure/Data.Migrations/Migrations/20250521000000_InitialCreate.cs  
**Description:** The initial, comprehensive database migration script generated by Entity Framework Core. This script contains the C# code to create all tables, columns, primary keys, foreign keys, indexes, and constraints as defined in the data model for the first deployment.  
**Template:** C# Migration  
**Dependency Level:** 2  
**Name:** InitialCreate  
**Type:** Migration  
**Relative Path:** Migrations/InitialCreate  
**Repository Id:** REPO-SAP-010  
**Pattern Ids:**
    
    
**Members:**
    
    
**Methods:**
    
    - **Name:** Up  
**Parameters:**
    
    - MigrationBuilder migrationBuilder
    
**Return Type:** void  
**Attributes:** protected override  
    - **Name:** Down  
**Parameters:**
    
    - MigrationBuilder migrationBuilder
    
**Return Type:** void  
**Attributes:** protected override  
    
**Implemented Features:**
    
    - Initial Database Schema Creation
    
**Requirement Ids:**
    
    - REQ-DLP-004
    - REQ-DLP-007
    - REQ-CSVC-016
    - REQ-CSVC-022
    
**Purpose:** To define the complete initial state of the database schema in a version-controlled, programmatic way, ensuring consistent database setup across all environments.  
**Logic Description:** The `Up` method will contain a series of `migrationBuilder.CreateTable` calls for all entities: User, Role, Permission, UserRole, RolePermission, OpcServer, OpcTag, Subscription, DataLog, HistoricalData, AlarmEvent, Dashboard, ReportTemplate, AuditLog, DataRetentionPolicy, PredictiveMaintenanceModel, BlockchainTransaction, and crucially, the `MigrationStrategy` table. Each call will define columns, types, constraints (nullable, max length), and establish primary and foreign keys. The `Down` method will contain corresponding `migrationBuilder.DropTable` calls in the reverse order to tear down the schema.  
**Documentation:**
    
    - **Summary:** This file programmatically defines the creation of the initial database schema. The `Up` method builds the schema, and the `Down` method reverts it.
    
**Namespace:** Opc.System.Infrastructure.Data.Migrations.Migrations  
**Metadata:**
    
    - **Category:** DataAccess
    
- **Path:** src/Infrastructure/Data.Migrations/Migrations/ApplicationDbContextModelSnapshot.cs  
**Description:** An auto-generated Entity Framework Core file that represents the current state of the database model. EF Core uses this file to compare against the entity configurations to determine what changes need to be made for a new migration. It should not be manually edited.  
**Template:** C# Model Snapshot  
**Dependency Level:** 2  
**Name:** ApplicationDbContextModelSnapshot  
**Type:** Snapshot  
**Relative Path:** Migrations/ApplicationDbContextModelSnapshot  
**Repository Id:** REPO-SAP-010  
**Pattern Ids:**
    
    
**Members:**
    
    
**Methods:**
    
    - **Name:** BuildModel  
**Parameters:**
    
    - ModelBuilder modelBuilder
    
**Return Type:** void  
**Attributes:** protected override  
    
**Implemented Features:**
    
    - Database Model State Tracking
    
**Requirement Ids:**
    
    - REQ-DLP-004
    - REQ-DLP-007
    - REQ-CSVC-016
    - REQ-CSVC-022
    
**Purpose:** To provide a snapshot of the current database model, enabling Entity Framework Core to compute differences and generate new migration scripts accurately.  
**Logic Description:** This file is entirely managed by EF Core. It contains a programmatic representation of the entire database model, including all entities, properties, relationships, keys, and indexes. When a new migration is added, EF Core compares the current DbContext configuration against this snapshot to generate the `Up` and `Down` methods of the new migration file.  
**Documentation:**
    
    - **Summary:** A machine-readable snapshot of the database model used by EF Core tools to track changes and generate migrations. This file is updated automatically with each new migration.
    
**Namespace:** Opc.System.Infrastructure.Data.Migrations.Migrations  
**Metadata:**
    
    - **Category:** DataAccess
    


---

# 2. Configuration

- **Feature Toggles:**
  
  
- **Database Configs:**
  
  - DesignTimeConnection
  


---

